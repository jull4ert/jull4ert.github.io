<!doctype html>
<html dir="ltr" lang="zh">
<head>
  <meta charset="utf-8">
  <title>JSON 篩選器 (JSONPath)</title>
  <link rel="icon" href="https://www.iconexperience.com/_img/o_collection_png/orange_dark_grey/16x16/plain/shelf_full.png" type="image/x-icon" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" crossorigin="anonymous">
  <style>
    body {
      background: #D8D8E8;
      margin: 0;
    }
    #suggestionBox {
      position: absolute;
      z-index: 2000;
      background: white;
      border: 1px solid #ddd;
      border-top: none;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    #suggestionBox a {
      display: block;
      padding: 6px 10px;
      cursor: pointer;
      text-decoration: none;
      color: black;
    }
    #suggestionBox a.active,
    #suggestionBox a:hover {
      background: #0d6efd;
      color: white;
    }
  </style>
</head>
<body class="p-5">
  <div>
    <h4>JSONPath 查詢</h4>
    <div class="mb-3 position-relative">
      <div class="input-group">
        <span class="input-group-text bg-info text-white">JSONPath</span>
        <input type="text" class="form-control" id="jsonPathInput" placeholder="例如：$.store.book[*].author">
        <button class="btn btn-success" id="runBtn">執行</button>
      </div>
      <!-- 建議清單放在 input-group 外，但仍在同一個相對定位容器 -->
      <div id="suggestionBox"></div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-8">
      <h4>輸入 JSON</h4>
      <textarea id="jsonInput" class="form-control mb-3" rows="20"
        placeholder='請貼上 JSON，例如 {"store":{"book":[{"author":"Nigel Rees","price":8.95}]}}'></textarea>
    </div>
    <div class="col-md-4">
      <h4>查詢結果</h4>
      <textarea id="output" class="form-control mb-3" rows="20" readonly></textarea>
    </div>
  </div>

  <div>
    <h4>JSONPath 範例</h4>
    <div class="accordion mt-3" id="exampleAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingExample">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample">
            點擊展開 / 摺疊
          </button>
        </h2>
        <div id="collapseExample" class="accordion-collapse collapse" data-bs-parent="#exampleAccordion">
          <div class="accordion-body">
            <ul>
              <li><code>$.store.book[*].author</code> ➝ 取出所有書籍作者</li>
              <li><code>$.store.book[?(@.price &lt; 10)]</code> ➝ 取出所有價格小於 10 的書</li>
              <li><code>$.store.book[?(@.isbn)]</code> ➝ 取出所有有 ISBN 的書</li>
              <li><code>$.store.bicycle.color</code> ➝ 取出腳踏車顏色</li>
              <li><code>$.store.book[0]</code> ➝ 取出第一本書</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script type="module">
    import { JSONPath } from "https://cdn.jsdelivr.net/npm/jsonpath-plus@10.0.0/dist/index-browser-esm.min.js";

    const pathInput = document.getElementById("jsonPathInput");
    const suggestionBox = document.getElementById("suggestionBox");
    let activeIndex = -1;

    document.getElementById("runBtn").addEventListener("click", () => {
      try {
        const json = JSON.parse(document.getElementById("jsonInput").value);
        const path = pathInput.value;
        const result = JSONPath({ path, json });
        document.getElementById("output").value = JSON.stringify(result, null, 2);
      } catch (e) {
        document.getElementById("output").value = "錯誤: " + e.message;
      }
    });

    pathInput.addEventListener("input", () => updateSuggestions());

    pathInput.addEventListener("keydown", (e) => {
      const items = suggestionBox.querySelectorAll("a");
      if (suggestionBox.style.display === "block" && items.length > 0) {
        if (e.key === "ArrowDown") {
          e.preventDefault();
          activeIndex = (activeIndex + 1) % items.length;
          updateActive(items);
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          activeIndex = (activeIndex - 1 + items.length) % items.length;
          updateActive(items);
        } else if (e.key === "Enter") {
          if (activeIndex >= 0) {
            e.preventDefault();
            items[activeIndex].click();
          }
        }
      }
    });

    function updateActive(items) {
      items.forEach((item, i) => {
        item.classList.toggle("active", i === activeIndex);
      });
    }

    function updateSuggestions() {
      suggestionBox.innerHTML = "";
      suggestionBox.style.display = "none";
      activeIndex = -1;

      try {
        const json = JSON.parse(document.getElementById("jsonInput").value);
        const path = pathInput.value;

        // "[" → 顯示 index 候選 (不補 "]")
        if (path.endsWith("[")) {
          const basePath = path.slice(0, -1);
          const result = JSONPath({ path: basePath, json });
          if (Array.isArray(result) && result.length > 0 && Array.isArray(result[0])) {
            const arr = result[0];
            const candidates = ["*"];
            for (let i = 0; i < arr.length; i++) candidates.push(i.toString());

            candidates.forEach(c => {
              const fullPath = path + c;
              const a = document.createElement("a");
              a.textContent = fullPath;
              a.addEventListener("click", () => {
                pathInput.value = fullPath;
                suggestionBox.style.display = "none";
              });
              suggestionBox.appendChild(a);
            });

            suggestionBox.style.display = "block";
          }
          return;
        }

        // slice "[n:" → 補 "]"
        const sliceMatch = path.match(/\[(\d+):$/);
        if (sliceMatch) {
          const startIdx = parseInt(sliceMatch[1], 10);
          const parentPath = path.slice(0, path.lastIndexOf("["));
          const result = JSONPath({ path: parentPath, json });
          if (Array.isArray(result) && result.length > 0 && Array.isArray(result[0])) {
            const arr = result[0];
            for (let i = startIdx + 1; i <= arr.length; i++) {
              const fullPath = parentPath + `[${startIdx}:${i}]`;
              const a = document.createElement("a");
              a.textContent = fullPath;
              a.addEventListener("click", () => {
                pathInput.value = fullPath;
                suggestionBox.style.display = "none";
              });
              suggestionBox.appendChild(a);
            }
            suggestionBox.style.display = "block";
          }
          return;
        }

        // 屬性自動完成
        const lastDot = path.lastIndexOf(".");
        if (lastDot !== -1) {
          const basePath = path.slice(0, lastDot);
          const partialKey = path.slice(lastDot + 1);
          const result = JSONPath({ path: basePath, json });

          if (Array.isArray(result) && result.length > 0) {
            const candidates = new Set();
            result.forEach(item => {
              if (typeof item === "object" && item !== null) {
                Object.keys(item).forEach(key => {
                  if (key.startsWith(partialKey)) candidates.add(key);
                });
              }
            });

            candidates.forEach(key => {
              const fullPath = basePath + "." + key;
              const a = document.createElement("a");
              a.textContent = fullPath;
              a.addEventListener("click", () => {
                pathInput.value = fullPath;
                suggestionBox.style.display = "none";
              });
              suggestionBox.appendChild(a);
            });

            if (candidates.size > 0) suggestionBox.style.display = "block";
          }
        }
      } catch {
        // ignore
      }
    }

    // 貼上時自動嘗試格式化 JSON
    document.getElementById("jsonInput").addEventListener("paste", (event) => {
      const paste = (event.clipboardData || window.clipboardData).getData("text");
      setTimeout(() => {
        try {
          const json = JSON.parse(document.getElementById("jsonInput").value);
          document.getElementById("jsonInput").value = JSON.stringify(json, null, 2);
        } catch {
          document.getElementById("jsonInput").value = paste;
        }
      }, 10);
    });
  </script>
</body>
</html>
